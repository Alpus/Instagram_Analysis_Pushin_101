{% extends "bootstrap/base.html" %}
{% block title %}Account information{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-md-12">
            <h1 class="text-center">Account information</h1>
        </div>
    </div>

    {% if is_media_on_update %}
    <div class="row">
        <div class="col-md-4 col-md-offset-2">
            <img src={{ user.profile_picture }} alt="Profile photo" align="middle" class="img-thumbnail">
            <h2>Hi, {{ user.login }}</h2>

            <p>Your Id is {{ user.inst_id_user }},</p>

            {% if user.full_name %}
                <p>Your full name is {{ user.full_name }},</p>
            {% else %}
                <p>You haven't written your fullname,</p>
            {% endif %}

            {% if user.bio %}
                <p>Your bio is "{{ user.bio }}",</p>
            {% else %}
                <p>You haven't written your bio,</p>
            {% endif %}

            {% if user.website %}
                <p>Your website is "{{ user.website }}".</p>
            {% else %}
                <p>You haven't written your website.</p>
            {% endif %}

            <h3>You have:</h3>

            <p>{{ user.count_media }} posts,</p>

            <p>{{ user.count_follows }} follows,</p>

            <p>{{ user.count_followed_by }} followers,</p>
        </div>
        <div class="col-md-4">
            <h2 class="text-center">Your profile is on updating, please try again a bit later</h2>
            <img src= {{ url_for('static', filename='img/loading.gif') }} alt="Loading" class="center-block">
            <h4 class="text-center">Page will be automatically updated when analysis is completed</h4>
        </div>
    </div>

    {% else %}

    <div class="row">
        <div class="col-md-4 col-md-offset-2">
            <img src={{ user.profile_picture }} alt="Profile photo" align="middle" class="img-thumbnail">
            <h2>Hi, {{ user.login }}</h2>

            <p>Your Id is {{ user.inst_id_user }},</p>

            {% if user.full_name %}
                <p>Your full name is {{ user.full_name }},</p>
            {% else %}
                <p>You haven't written your fullname,</p>
            {% endif %}

            {% if user.bio %}
                <p>Your bio is "{{ user.bio }}",</p>
            {% else %}
                <p>You haven't written your bio,</p>
            {% endif %}

            {% if user.website %}
                <p>Your website is "{{ user.website }}".</p>
            {% else %}
                <p>You haven't written your website.</p>
            {% endif %}

            <h3>You have:</h3>

            <p>{{ user.count_media }} posts,</p>

            <p>{{ user.count_follows }} follows,</p>

            <p>{{ user.count_followed_by }} followers,</p>

            <p>{{ sum_of_likes }} likes,</p>

            <p>Average like count is {{ '%0.2f' % ((sum_of_likes/user.count_media)) | float }},</p>


            <h3 class="text-center">Your most likable posts:</h3>
            <table class="table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Image</th>
                    <th>Information</th>
                </tr>
                </thead>
                <tbody>
                {% for media in most_liked_media | batch(8) | first %}
                    <tr>
                        <th>{{ media[0] + 1 }}</th>
                        <th>
                            <img src={{ media[1].image_thumbnail }} alt="Media" class="img-thumbnail">
                        </th>
                        <th>
                            <p>Likes: {{ media[1].count_of_likes }}</p>
                            {% if media[1].location %}
                                <p>Location: {{ media[1].location.name }}</p>
                            {% endif %}
                            <p>Filter: {{ media[1].filter_media }}</p>
                            {% if media[1].caption %}
                                <p>Caption: {{ media[1].caption }}</p>
                            {% endif %}
                        </th>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

        </div>
        <div class="col-md-4">
            {% if liker_count == 0 or median_like_count > 240 %}
                <h3>Sorry, you have too much likes to make representational user statistic</h3>
                <p>You are just too popular!)</p>
            {% else %}
                <h3 class="text-center">Users who have liked you:</h3>
                <table class="table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>User picture</th>
                        <th>Information</th>
                        <th>~Count of likes</th>
                        <th>~% of posts</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for liker in users_who_liked | batch(20) | first %}
                        <tr>
                            <th>{{ liker[0] + 1 }}</th>
                            <th>
                                <img src={{ liker[1][0].profile_picture }} width="50" height="50" alt="Profile photo"
                                     align="middle" class="img-thumbnail">
                            </th>
                            <th>
                                <p>Login: {{ liker[1][0].login }}</p>
                                {%  if liker[1][0] in followed_by %}
                                    <p>Your follower</p>
                                {% endif %}
                                {%  if liker[1][0] in follows %}
                                    <p>Followed by you</p>
                                {% endif %}
                            </th>
                            <th>
                                {{ liker[1][1] }}
                            </th>
                            <th>
                                {{ '%0.2f' %  ((liker[1][1] / user.count_media) * 100) | float }}%
                            </th>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
    </div>


    <div class="row">
        <div class="col-md-12">
            <h2 class="text-center">Locations</h2>
        </div>
    </div>

    {% if location_count_all %}
        <div class="row">
            <div class="col-md-4 col-md-offset-2">
                <h3 class="text-center">Locations counting</h3>

                <p class="text-center">You have used {{ location_count_all }} tags where
                    {{ location_count_unique }} is unique.</p>
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Location</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for location in user_locations | batch(15) | first %}
                        <tr>
                            <th>{{ location[0] + 1 }}</th>
                            <th>
                                {{ location[1][0].name }}
                            </th>
                            <th>
                                {{ location[1][1] }}
                            </th>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col-md-4">
                <h3 class="text-center">Location liking</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Location</th>
                            <th>Average like count</th>
                            <th>The most liked post with location</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for location in location_likes | batch(8) | first %}
                        <tr>
                            <th>{{ location[0] + 1 }}</th>
                            <th>
                                {{ location[1][0].name }}
                            </th>
                            <th>
                                {{ '%0.2f' % location[1][1][0] | float }}
                            </th>
                            <th>
                                <img src={{ location[1][1][1].image_thumbnail }} width="50" height="50" alt="Media photo"
                                     align="middle" class="img-thumbnail">
                            </th>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <p class="text-center">You have no locations</p>
    {% endif %}


    <div class="row">
        <div class="col-md-12">
            <h2 class="text-center">Filters</h2>
        </div>
    </div>

    {% if filter_count %}
        <div class="row">
            <div class="col-md-4 col-md-offset-2">
                <h3 class="text-center">Filters counting</h3>

                <p class="text-center">You have used {{ filter_count }} filters.</p>
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Filter</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for filter in user_filters | batch(15) | first %}
                        <tr>
                            <th>{{ filter[0] + 1 }}</th>
                            <th>
                                {{ filter[1][0] }}
                            </th>
                            <th>
                                {{ filter[1][1] }}
                            </th>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col-md-4">
                <h3 class="text-center">Filter liking</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Filter</th>
                            <th>Average like count</th>
                            <th>The most liked post with filter</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for filter in filter_likes | batch(8) | first %}
                        <tr>
                            <th>{{ filter[0] + 1 }}</th>
                            <th>
                                {{ filter[1][0] }}
                            </th>
                            <th>
                                {{ '%0.2f' % filter[1][1][0] | float }}
                            </th>
                            <th>
                                <img src={{ filter[1][1][1].image_thumbnail }} width="50" height="50" alt="Media photo"
                                     align="middle" class="img-thumbnail">
                            </th>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <p class="text-center">You have no filters</p>
    {% endif %}


    <div class="row">
        <div class="col-md-12">
            <h2 class="text-center">Tags</h2>
        </div>
    </div>

    {% if tag_count_all %}
        <div class="row">
            <div class="col-md-4 col-md-offset-2">
                <h3 class="text-center">Tags counting</h3>

                <p class="text-center">You have used {{ tag_count_all }} tags where {{ tag_count_unique }} is unique.</p>
                <table class="table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Tag</th>
                        <th>Count</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for tag in user_tags | batch(9) | first %}
                        <tr>
                            <th>{{ tag[0] + 1 }}</th>
                            <th>
                                {{ tag[1][0].name }}
                            </th>
                            <th>
                                {{ tag[1][1] }}
                            </th>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col-md-4">
                <h3 class="text-center">Tag liking</h3>
                <table class="table">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Tag</th>
                        <th>Average like count</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for tag in tags_likes | batch(10) | first %}
                        <tr>
                            <th>{{ tag[0] + 1 }}</th>
                            <th>
                                {{ tag[1][0].name }}
                            </th>
                            <th>
                                {{ '%0.2f' % tag[1][1] | float }}
                            </th>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <p class="text-center">You have no tags</p>
    {% endif %}

    {% endif %}

    <div class="row">
        <div class="col-md-12">
            <h1 class="text-center">
                <a href={{ home_url }} type="button" class="btn btn-danger btn-lg">Return</a>
            </h1>
        </div>
    </div>
{% endblock %}


{% block scripts %}
    {% if is_media_on_update %}
        {{ super() }}
        <script>
        function reload_with_analysis () {
            $.getJSON(location.href + '/is_on_update',
                    function (data) {
                        if (!data.is_on_update) {
                            location.reload(true);
                }
            });
        }
        $(document).ready( function() {
            setInterval(reload_with_analysis, 5000);
        });
        </script>
    {% endif %}
{% endblock %}